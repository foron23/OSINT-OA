# Telegram MCP Setup Guide

## Overview

OSINT OA uses the Telegram MCP (Model Context Protocol) server to publish investigation reports to Telegram chats, channels, or users.

## Configuration

### 1. Environment Variables

Add these to your `.env` file:

```bash
# Telegram API Credentials (get from https://my.telegram.org)
TELEGRAM_APP_ID=35016649
TELEGRAM_API_HASH=1e9a9f368609a125023e5e79d9004958

# Optional: Default target dialog
TELEGRAM_TARGET_DIALOG=osint_reports
```

### 2. Install Telegram MCP Server

The Telegram MCP server is provided by `@chaindead/telegram-mcp`. Make sure you have Node.js installed:

```bash
# Install npx if not available
npm install -g npx

# Test the server (first run will prompt for authentication)
npx @chaindead/telegram-mcp --app-id YOUR_APP_ID --api-hash YOUR_API_HASH
```

### 3. First-Time Authentication

On first run, the Telegram MCP server will:
1. Ask for your phone number
2. Send a verification code to your Telegram
3. Store the session for future use

## Usage

### Running with MCP Inspector

To test the Telegram MCP server with the inspector:

```bash
npx @modelcontextprotocol/inspector @chaindead/telegram-mcp \
  --app-id 92374962 \
  --api-hash uyewoiteoqt3874102
```

### Available MCP Tools

The Telegram MCP server provides these tools:

| Tool | Description |
|------|-------------|
| `tg_dialogs` | List all Telegram dialogs (chats, channels, users) |
| `tg_dialog` | Get messages from a specific dialog |
| `tg_send` | Send a message to a dialog |
| `tg_read` | Mark messages as read |
| `tg_me` | Get current account info |

## How It Works in OSINT OA

1. **ConsolidatorAgent** - Collects results from all agents and generates a report
2. **TelegramMCPClient** - Connects to the Telegram MCP server
3. **Report Publishing** - Sends the formatted report to the target dialog

### Fallback Behavior

If the Telegram MCP server is not running:
- Reports are saved locally to `./data/telegram_reports/`
- The investigation still completes successfully
- Reports can be manually sent later

## Report Format

The ConsolidatorAgent generates reports with this structure:

```markdown
## ðŸ“Š Investigation Report

**Query:** `<query>`
**Date:** 2025-12-14 18:00 UTC
**Items Analyzed:** 19
**Sources:** TavilySearchAgent, DuckDuckGoSearchAgent

---

### ðŸŽ¯ Executive Summary
Investigation identified X relevant items...

### ðŸ“Œ Key Findings
1. [Finding Title](url)
   _Summary..._

### ðŸ”´ Indicators of Compromise
**IP:** `1.2.3.4`
**Domain:** `malicious.com`
**CVE:** CVE-2024-1234

---
_Generated by OSINT OA_
```

## Troubleshooting

### "MCP tool call failed"

This usually means the Telegram MCP server is not running. Start it with:

```bash
npx @chaindead/telegram-mcp --app-id YOUR_APP_ID --api-hash YOUR_API_HASH
```

### "Not Found" errors

The target dialog doesn't exist. Use `tg_dialogs` to list available dialogs:

```python
from integrations.telegram_mcp_client import TelegramMCPClient
import asyncio

client = TelegramMCPClient()
dialogs = asyncio.run(client.list_dialogs())
print(dialogs)
```

### Authentication Required

If you need to re-authenticate:
1. Delete the Telegram session file (usually in `~/.telegram-mcp/`)
2. Run the MCP server again to re-authenticate

## Development

### Testing Without Telegram

Set `dry_run=True` when calling the client:

```python
result = await client.send_message("test_chat", "Test message", dry_run=True)
```

### Local Report Storage

Reports are automatically saved to `./data/telegram_reports/` when:
- Telegram MCP server is not running
- An error occurs during publishing
- You want to review before sending
