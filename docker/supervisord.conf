# =============================================================================
# Supervisord Configuration - OSINT News Aggregator
# =============================================================================
# Gestiona m√∫ltiples procesos dentro del contenedor Docker:
# 1. Gunicorn (Flask API) - Puerto 5000
# 2. Telegram MCP Service - Puerto 5001
#
# Uso:
#   supervisord -c /etc/supervisor/conf.d/supervisord.conf
# =============================================================================

[supervisord]
nodaemon=true
user=root
logfile=/app/logs/supervisord.log
logfile_maxbytes=10MB
logfile_backups=3
loglevel=info
pidfile=/tmp/supervisord.pid

# =============================================================================
# Flask API (Gunicorn)
# =============================================================================
[program:flask-api]
command=/opt/venv/bin/gunicorn
    --bind 0.0.0.0:5000
    --workers %(ENV_GUNICORN_WORKERS)s
    --threads %(ENV_GUNICORN_THREADS)s
    --worker-class gthread
    --timeout %(ENV_GUNICORN_TIMEOUT)s
    --keep-alive 5
    --graceful-timeout 30
    --access-logfile -
    --error-logfile -
    --capture-output
    --log-level info
    app:app
directory=/app
user=osint
autostart=true
autorestart=true
startsecs=5
startretries=3
stopwaitsecs=30
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=
    PYTHONPATH="/app",
    PYTHONUNBUFFERED="1",
    TELEGRAM_MCP_USE_SERVICE="true",
    TELEGRAM_MCP_SERVICE_URL="http://localhost:5001"

# =============================================================================
# Telegram MCP Service (HTTP wrapper for telegram-mcp binary)
# =============================================================================
[program:telegram-mcp-service]
command=/opt/venv/bin/python -m integrations.telegram.mcp_service
directory=/app
user=osint
autostart=true
autorestart=true
startsecs=3
startretries=3
stopwaitsecs=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=
    PYTHONPATH="/app",
    PYTHONUNBUFFERED="1",
    TELEGRAM_MCP_SERVICE_HOST="0.0.0.0",
    TELEGRAM_MCP_SERVICE_PORT="5001",
    TG_APP_ID="%(ENV_TG_APP_ID)s",
    TG_API_HASH="%(ENV_TG_API_HASH)s",
    TELEGRAM_APP_ID="%(ENV_TELEGRAM_APP_ID)s",
    TELEGRAM_API_HASH="%(ENV_TELEGRAM_API_HASH)s",
    TELEGRAM_SESSION_PATH="%(ENV_TELEGRAM_SESSION_PATH)s",
    TELEGRAM_MCP_PATH="%(ENV_TELEGRAM_MCP_PATH)s"

# =============================================================================
# Telegram Listener (polls for messages and processes commands)
# =============================================================================
[program:telegram-listener]
command=/opt/venv/bin/python -m integrations.telegram.listener
directory=/app
user=osint
autostart=true
autorestart=true
startsecs=5
startretries=3
stopwaitsecs=15
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=
    PYTHONPATH="/app",
    PYTHONUNBUFFERED="1",
    TELEGRAM_MCP_USE_SERVICE="true",
    TELEGRAM_MCP_SERVICE_URL="http://localhost:5001",
    TELEGRAM_TARGET_DIALOG="%(ENV_TELEGRAM_TARGET_DIALOG)s",
    TG_APP_ID="%(ENV_TG_APP_ID)s",
    TG_API_HASH="%(ENV_TG_API_HASH)s",
    TELEGRAM_APP_ID="%(ENV_TELEGRAM_APP_ID)s",
    TELEGRAM_API_HASH="%(ENV_TELEGRAM_API_HASH)s"

# =============================================================================
# Group Configuration
# =============================================================================
[group:osint-services]
programs=flask-api,telegram-mcp-service,telegram-listener
priority=999

# =============================================================================
# Supervisor Control Interface
# =============================================================================
[unix_http_server]
file=/tmp/supervisor.sock
chmod=0700
chown=osint:osint

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface
