# =============================================================================
# OSINT OA - Production Docker Compose
# =============================================================================
# Configuración completa para despliegue en producción
#
# ┌─────────────────────────────────────────────────────────────────────────┐
# │                         GUÍA DE DESPLIEGUE                              │
# ├─────────────────────────────────────────────────────────────────────────┤
# │                                                                          │
# │ REQUISITOS PREVIOS:                                                      │
# │ 1. Docker Engine 20.10+ instalado                                       │
# │ 2. Docker Compose v2.0+ instalado                                       │
# │ 3. Archivo .env configurado (ver .env.example)                          │
# │                                                                          │
# │ PASOS DE DESPLIEGUE:                                                    │
# │                                                                          │
# │ 1. Copiar archivos al servidor:                                         │
# │    scp -r . usuario@servidor:/opt/osint-oa                              │
# │                                                                          │
# │ 2. Configurar variables de entorno:                                     │
# │    cp .env.example .env                                                 │
# │    nano .env  # Editar con tus API keys                                 │
# │                                                                          │
# │ 3. Construir y levantar:                                                │
# │    docker-compose -f docker-compose.prod.yml build                      │
# │    docker-compose -f docker-compose.prod.yml up -d                      │
# │                                                                          │
# │ 4. Verificar estado:                                                    │
# │    docker-compose -f docker-compose.prod.yml ps                         │
# │    docker-compose -f docker-compose.prod.yml logs -f                    │
# │                                                                          │
# │ 5. Configurar Telegram (primera vez):                                   │
# │    docker-compose -f docker-compose.prod.yml exec osint-oa \            │
# │      python scripts/setup-telegram.py                                    │
# │                                                                          │
# │ ACTUALIZACIONES:                                                        │
# │    docker-compose -f docker-compose.prod.yml pull                       │
# │    docker-compose -f docker-compose.prod.yml up -d --build              │
# │                                                                          │
# │ BACKUP:                                                                  │
# │    docker run --rm -v osint-oa-data-prod:/data -v $(pwd):/backup \      │
# │      alpine tar czf /backup/osint-backup-$(date +%Y%m%d).tar.gz /data   │
# │                                                                          │
# └─────────────────────────────────────────────────────────────────────────┘
# =============================================================================

services:
  # ===========================================================================
  # OSINT OA - Main Application
  # ===========================================================================
  osint-oa:
    build:
      context: .
      dockerfile: Dockerfile.prod
      # Cache de layers para builds más rápidos
      cache_from:
        - osint-oa:latest
    
    image: osint-oa:prod
    container_name: osint-oa-prod
    hostname: osint-oa
    
    # Política de reinicio para producción
    restart: always
    
    # ==========================================================================
    # Puertos
    # ==========================================================================
    ports:
      # Puerto configurable via .env, default 5000
      - "${HOST_PORT:-5000}:5000"
    
    # ==========================================================================
    # Variables de Entorno
    # ==========================================================================
    # Cargar todas las variables desde .env
    env_file:
      - .env
    
    # Variables específicas para el contexto Docker (sobrescriben .env)
    environment:
      # Desactivar debug en producción
      - FLASK_DEBUG=0
      - FLASK_ENV=production
      
      # Paths dentro del contenedor (no modificar)
      - DATABASE_PATH=/app/data/osint.db
      - TELEGRAM_SESSION_PATH=/app/data/telegram-session
      
      # Gunicorn (ajustar según recursos del servidor)
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-4}
      - GUNICORN_THREADS=${GUNICORN_THREADS:-2}
      - GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT:-120}
    
    # ==========================================================================
    # Volúmenes Persistentes
    # ==========================================================================
    volumes:
      # Base de datos SQLite y reportes generados
      # IMPORTANTE: Este volumen contiene todos los datos de la aplicación
      - osint-data:/app/data
      
      # Sesión de Telegram (autenticación persistente con Telethon)
      # Bind mount desde el directorio del host para permitir pre-cargar sesión existente
      # 
      # Configurar en .env:
      #   TELEGRAM_SESSION_HOST_PATH=/ruta/absoluta/a/.telegram-session
      # 
      # O usar ruta relativa (relativa al docker-compose.yml):
      #   TELEGRAM_SESSION_HOST_PATH=./.telegram-session
      #
      # IMPORTANTE: El directorio debe existir antes de levantar el contenedor
      - ${TELEGRAM_SESSION_HOST_PATH:-./.telegram-session}:/app/data/telegram-session
      
      # Logs de la aplicación (opcional, para debugging)
      - osint-logs:/app/logs
    
    # ==========================================================================
    # Health Check
    # ==========================================================================
    # Verifica Flask API
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/api/runs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 25s
    
    # ==========================================================================
    # Límites de Recursos
    # ==========================================================================
    # Ajustar según el servidor de destino
    deploy:
      resources:
        limits:
          # Máximo 4 CPUs y 4GB RAM
          cpus: '4'
          memory: 4G
        reservations:
          # Mínimo garantizado
          cpus: '1'
          memory: 1G
      
      # Política de reinicio para Docker Swarm (si se usa)
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    
    # ==========================================================================
    # Logging
    # ==========================================================================
    logging:
      driver: "json-file"
      options:
        # Rotación de logs: máximo 50MB por archivo, 5 archivos
        max-size: "50m"
        max-file: "5"
        # Añadir labels para mejor identificación
        labels: "service,environment"
    
    # ==========================================================================
    # Seguridad
    # ==========================================================================
    security_opt:
      # Prevenir escalación de privilegios
      - no-new-privileges:true
    
    # Sistema de archivos temporal para /tmp
    tmpfs:
      - /tmp:size=100M,mode=1777
    
    # Labels para identificación
    labels:
      - "com.osint.service=osint-oa"
      - "com.osint.environment=production"
      - "com.osint.version=2.0.0"
    
    # Dependencias de red
    networks:
      - osint-network

# =============================================================================
# Volúmenes Nombrados
# =============================================================================
# Estos volúmenes persisten datos entre reinicios y actualizaciones
volumes:
  # Base de datos SQLite y archivos generados
  osint-data:
    driver: local
    name: osint-oa-data-prod
    labels:
      - "com.osint.volume=data"
      - "com.osint.backup=required"
  
  # Logs de la aplicación
  osint-logs:
    driver: local
    name: osint-oa-logs-prod
    labels:
      - "com.osint.volume=logs"
      - "com.osint.backup=optional"

# =============================================================================
# Redes
# =============================================================================
networks:
  osint-network:
    name: osint-oa-network-prod
    driver: bridge
    # Configuración de red personalizada (opcional)
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

